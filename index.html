<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SBT Trait Sync</title>
</head>
<body>
    <h1>SBT Trait Sync Tool</h1>
    <input type="text" id="walletAddress" placeholder="Enter wallet address">
    <button id="fetchDiffs">Fetch Differences</button>
    <div id="diffOutput"></div>
    <button id="updateTraits" style="display:none;">Update My Traits</button>

    <script>
    async function fetchDifferences() {
        const address = document.getElementById("walletAddress").value.trim();
        if (!address) {
            alert("Please enter a wallet address.");
            return;
        }

        const res = await fetch(`http://localhost:5000/api/trait-diff?address=${address}`);
        const diffs = await res.json();

        const outputDiv = document.getElementById("diffOutput");
        outputDiv.innerHTML = "";

        if (Object.keys(diffs).length === 0) {
            outputDiv.innerHTML = "<p>âœ… No differences found.</p>";
            document.getElementById("updateTraits").style.display = "none";
            return;
        }

        let html = "<h3>Differences:</h3><ul>";
        for (const [key, diff] of Object.entries(diffs)) {
            html += `<li>${key}: On-chain = ${diff.on_chain}, Off-chain = ${diff.off_chain}</li>`;
        }
        html += "</ul>";
        outputDiv.innerHTML = html;

        document.getElementById("updateTraits").style.display = "inline-block";
        document.getElementById("updateTraits").onclick = () => updateTraits(address, diffs);
    }

    async function updateTraits(address, diffs) {
        // NOTE: This requires a wallet integration.
        // Here we just log the intended transactions.
        for (const [key, diff] of Object.entries(diffs)) {
            console.log(`Would update ${key} to ${diff.off_chain} for ${address}`);

            // Example transaction (replace with real wallet call):
            /*
            await wallet.sendTransaction({
                contract: "con_sbt_traits",
                function: "update_trait",
                kwargs: {
                    key: key,
                    value: String(diff.off_chain)
                },
                stamps: 50
            });
            */
        }
        alert("Update transactions sent! Check your wallet.");
    }

    document.getElementById("fetchDiffs").addEventListener("click", fetchDifferences);
    </script>
</body>
</html>
